<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>SAP Certified Associate - Back-End Developer - ABAP Cloud Quiz</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="../all.css">
    <link rel="icon" type="image/png" href="../Img/icon1.png">
</head>

<body>

    <div class="quiz-container">
        <h1>SAP Certified Associate - Back-End Developer - ABAP Cloud</h1>
        <div class="progress">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <h2>Select Practice Mode:</h2>
        <button class="btn" onclick="loadRandomQuestion()">Random Practice (45 Questions)</button>
        <button class="btn" onclick="startFullExam()">Full Exam (All Questions)</button>
        <button class="btn" onclick="showPracticeRangeForm()">Custom Range Practice</button>
        <div class="quiz-layout">
            <div class="quiz-main">
                <div id="quiz" style="display: none;"></div>
                <div class="feedback" id="feedback" style="display: none;"></div>
                <button class="btn" id="submit-btn" style="display: none;" onclick="submitAnswer()">Submit</button>
                <button class="btn" id="next-btn" style="display: none;" onclick="nextQuestion()">Next</button>
            </div>
            <div class="quiz-aside">
                <div class="score-container" id="score-container" style="display:none;">
                    <canvas id="scoreChart"></canvas>
                    <div id="scoreSummary" class="score-summary"></div>
                    <button class="btn" id="start-over-btn" onclick="location.reload()">Start Over</button>
                </div>
            </div>
        </div>
    </div>

    <div id="popupOverlay"></div>
    <div id="practicePopup">
        <div class="question">Enter Question Range to Practice (1 - 90):</div>
        <h3 id="availableCount">90 Questions available</h3>
        <div class="range-inputs">
            <input type="number" id="rangeStart" placeholder="Start (e.g. 2)" />
            <input type="number" id="rangeEnd" placeholder="End (e.g. 50)" />
        </div>
        <button class="btn" onclick="startPracticeRange()">Start Practice</button>
    </div>

    <script src="./C_ABAPD.js"></script>
<script>
  (function () {
    const questions = globalThis.questions || [];

    const state = {
      currentIndex: 0,
      score: 0,
      customQuestionList: [],
      totalQuestions: 0
    };

    const progressBar = document.getElementById("progressBar");
    const quizNode = document.getElementById("quiz");
    const feedbackNode = document.getElementById("feedback");
    const submitBtn = document.getElementById("submit-btn");
    const nextBtn = document.getElementById("next-btn");
    const scoreContainer = document.getElementById("score-container");

    function shuffleArray(arr) {
      const a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function updateProgress() {
      const pct = state.totalQuestions ? Math.round((state.currentIndex / state.totalQuestions) * 100) : 0;
      if (progressBar) progressBar.style.width = `${pct}%`;
    }

    function renderCurrentQuestion() {
      if (!quizNode || !feedbackNode || !submitBtn || !nextBtn) return;

      quizNode.style.display = "block";
      submitBtn.style.display = "inline-block";
      nextBtn.style.display = "none";
      feedbackNode.style.display = "block";
      feedbackNode.innerText = "";

      const q = state.customQuestionList[state.currentIndex];
      if (!q) return;

      const isMultiple = Array.isArray(q.answer) && q.answer.length > 1;
      let html = `<div class="question">Question ${state.currentIndex + 1} / ${state.totalQuestions}: ${q.question}</div>`;
      if (isMultiple) {
        html += `<div style="font-size:0.9em; color:#333; margin-bottom:8px;">(Select all that apply)</div>`;
      }
      html += `<div class="options">`;

      q.options.forEach((opt, i) => {
        html += `<label><input type="${isMultiple ? "checkbox" : "radio"}" name="option" value="${i}"> ${opt}</label>`;
      });

      html += `</div>`;
      quizNode.innerHTML = html;

      updateProgress();
    }

    function loadRandomQuestion() {
      if (!Array.isArray(questions) || questions.length === 0) {
        alert("Questions not loaded. Check C_ABAPD.js");
        return;
      }

      state.customQuestionList = shuffleArray(questions).slice(0, 45);
      state.totalQuestions = state.customQuestionList.length;
      state.currentIndex = 0;
      state.score = 0;

      const quizContainer = document.querySelector(".quiz-container");
      if (quizContainer) {
        const h2 = quizContainer.querySelector("h2");
        if (h2) h2.style.display = "none";
        quizContainer.querySelectorAll("button").forEach(btn => { btn.style.display = "none"; });
      }

      if (scoreContainer) scoreContainer.style.display = "none";
      renderCurrentQuestion();
    }

    function startFullExam() {
      if (!Array.isArray(questions) || questions.length === 0) {
        alert("Questions not loaded. Check C_ABAPD.js");
        return;
      }

      state.customQuestionList = [...questions];
      state.totalQuestions = state.customQuestionList.length;
      state.currentIndex = 0;
      state.score = 0;

      const quizContainer = document.querySelector(".quiz-container");
      if (quizContainer) {
        const h2 = quizContainer.querySelector("h2");
        if (h2) h2.style.display = "none";
        quizContainer.querySelectorAll("button").forEach(btn => { btn.style.display = "none"; });
      }

      if (scoreContainer) scoreContainer.style.display = "none";
      renderCurrentQuestion();
    }

    function showPracticeRangeForm() {
      const available = Array.isArray(questions) ? questions.length : 0;
      const availableCount = document.getElementById("availableCount");
      if (availableCount) availableCount.innerText = `${available} Questions available`;

      const popup = document.getElementById("practicePopup");
      const overlay = document.getElementById("popupOverlay");
      if (popup) popup.style.display = "block";
      if (overlay) overlay.style.display = "block";
    }

    function startPracticeRange() {
      const startField = document.getElementById("rangeStart");
      const endField = document.getElementById("rangeEnd");
      if (!startField || !endField) return;

      const startVal = parseInt(startField.value, 10);
      const endVal = parseInt(endField.value, 10);
      if (Number.isNaN(startVal) || Number.isNaN(endVal)) {
        alert("Please enter numeric start and end.");
        return;
      }

      const start = startVal - 1;
      const end = endVal;
      if (start < 0 || !Array.isArray(questions) || end > questions.length || start >= end) {
        alert("Please enter a valid range within the available questions.");
        return;
      }

      state.customQuestionList = questions.slice(start, end);
      state.totalQuestions = state.customQuestionList.length;
      state.currentIndex = 0;
      state.score = 0;

      const popup = document.getElementById("practicePopup");
      const overlay = document.getElementById("popupOverlay");
      if (popup) popup.style.display = "none";
      if (overlay) overlay.style.display = "none";

      const quizContainer = document.querySelector(".quiz-container");
      if (quizContainer) {
        const h2 = quizContainer.querySelector("h2");
        if (h2) h2.style.display = "none";
        quizContainer.querySelectorAll("button").forEach(btn => { btn.style.display = "none"; });
      }

      if (scoreContainer) scoreContainer.style.display = "none";
      renderCurrentQuestion();
    }

    function submitAnswer() {
      const selectedNodes = Array.from(document.querySelectorAll('input[name="option"]:checked'));
      if (!selectedNodes.length) {
        alert("Please select an option.");
        return;
      }

      const q = state.customQuestionList[state.currentIndex];
      if (!q) return;

      const correctOptions = Array.isArray(q.answer) ? q.answer.map(Number) : [Number(q.answer)];
      const selectedValues = selectedNodes.map(n => Number(n.value));

      const selectedSet = new Set(selectedValues);
      const correctSet = new Set(correctOptions);
      const isCorrect = selectedSet.size === correctSet.size && [...selectedSet].every(v => correctSet.has(v));

      const correctText = correctOptions.map(i => q.options[i]).join(", ");

      if (feedbackNode) {
        if (isCorrect) {
          state.score++;
          feedbackNode.innerHTML = "<span class=\"feedback-success\">✅ Correct!</span>";
        } else {
          feedbackNode.innerHTML = `
            <span class="feedback-label">❌ Incorrect. Correct answer:</span>
            <span class="feedback-answer">${correctText}</span>
          `;
        }
      }

      if (submitBtn) submitBtn.style.display = "none";
      if (nextBtn) nextBtn.style.display = "inline-block";
    }

    function nextQuestion() {
      state.currentIndex += 1;
      if (state.currentIndex < state.totalQuestions) {
        renderCurrentQuestion();
      } else {
        showScore();
      }
    }

    function showScore() {
      if (quizNode) quizNode.style.display = "none";
      if (submitBtn) submitBtn.style.display = "none";
      if (nextBtn) nextBtn.style.display = "none";
      if (feedbackNode) feedbackNode.style.display = "none";
      if (progressBar) progressBar.style.width = "100%";
      if (scoreContainer) scoreContainer.style.display = "block";

      const chartHolder = document.getElementById("scoreChart");
      const summaryNode = document.getElementById("scoreSummary");
      if (!chartHolder) return;

      const total = state.totalQuestions;
      const safeTotal = total > 0 ? total : 1;
      const incorrectCount = Math.max(safeTotal - state.score, 0);

      if (summaryNode) {
        const displayTotal = total > 0 ? total : 0;
        summaryNode.textContent = `✅ ${state.score} / ${displayTotal}`;
      }

      const oldCanvas = document.getElementById("scoreChart");
      if (oldCanvas) oldCanvas.remove();

      const canvas = document.createElement("canvas");
      canvas.id = "scoreChart";
      canvas.width = 200;
      canvas.height = 200;
      if (scoreContainer) scoreContainer.prepend(canvas);

      const ctx = canvas.getContext("2d");
      if (!ctx) return;

      new Chart(ctx, {
        type: "doughnut",
        data: {
          datasets: [
            {
              data: [state.score, incorrectCount],
              backgroundColor: ["#4caf50", "#eee"],
              borderWidth: 2
            }
          ]
        },
        options: {
          cutout: "70%",
          plugins: {
            tooltip: { enabled: false },
            legend: { display: false },
            title: { display: false }
          }
        }
      });
    }

    function init() {
      if (!Array.isArray(questions) || questions.length === 0) {
        console.warn("No questions loaded. Buttons will remain hidden.");
        return;
      }

      window.loadRandomQuestion = loadRandomQuestion;
      window.startFullExam = startFullExam;
      window.showPracticeRangeForm = showPracticeRangeForm;
      window.startPracticeRange = startPracticeRange;
      window.submitAnswer = submitAnswer;
      window.nextQuestion = nextQuestion;

      document.addEventListener("DOMContentLoaded", () => {
        const availableCount = document.getElementById("availableCount");
        if (availableCount) availableCount.innerText = `${questions.length} Questions available`;
      });
    }

    init();
  })();
</script>
</body>

</html>